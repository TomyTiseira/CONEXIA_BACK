services:
  nats-server:
    image: nats:2.10.25-alpine3.21
    ports:
      - "4222:4222"
      - "8222:8222"

  api-gateway:
    build: ./api-gateway
    ports:
      - "${API_GATEWAY_PORT}:${API_GATEWAY_PORT}"
    volumes:
      - ./api-gateway/src:/src/app/src
      - ./api-gateway/uploads:/src/app/uploads
      - ./api-gateway/uploads/cv:/src/app/uploads/cv
    command: npm run start:dev
    depends_on:
      - nats-server
    environment:
      - NATS_SERVERS=nats://nats-server:4222
      - PORT=${API_GATEWAY_PORT}
      - JWT_SECRET=${JWT_SECRET}
      - CORS_ORIGINS=${CORS_ORIGINS}
      - NODE_ENV=${NODE_ENV}

  users:
    build: ./users
    volumes:
      - ./users/src:/src/app/src
    depends_on:
      users-db:
        condition: service_healthy
    environment:
      - NATS_SERVERS=nats://nats-server:4222
      - DB_HOST=users-db
      - DB_PORT=${USERS_DB_PORT}
      - DB_USERNAME=${USERS_DB_USER}
      - DB_PASSWORD=${USERS_DB_PASSWORD}
      - DB_DATABASE=${USERS_DB_NAME}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_SECURE=${SMTP_SECURE}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - EMAIL_FROM=${EMAIL_FROM}
      - JWT_SECRET=${JWT_SECRET}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - ALGORITHM=${ALGORITHM}

  users-db:
    build:
      context: ./users
      dockerfile: Dockerfile.postgres
    ports:
      - "${USERS_DB_PORT}:${USERS_DB_PORT}"
    environment:
      - POSTGRES_USER=${USERS_DB_USER}
      - POSTGRES_PASSWORD=${USERS_DB_PASSWORD}
      - POSTGRES_DB=${USERS_DB_NAME}
    volumes:
      - ./users/postgres-data:/var/lib/postgresql/data
      - ./users/postgres-init:/docker-entrypoint-initdb.d
    command: >
      postgres
      -c listen_addresses='*'
      -c max_connections=100
      -c timezone='America/Argentina/Buenos_Aires'
      -c log_timezone='America/Argentina/Buenos_Aires'
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${USERS_DB_USER} -d ${USERS_DB_NAME}"]
      interval: 5s
      timeout: 5s
      retries: 5

  projects:
    build: ./projects
    volumes:
      - ./projects/src:/src/app/src
    depends_on:
      projects-db:
        condition: service_healthy
    environment:
      - NATS_SERVERS=nats://nats-server:4222
      - DB_HOST=projects-db
      - DB_PORT=5432
      - DB_USERNAME=${PROJECTS_DB_USER}
      - DB_PASSWORD=${PROJECTS_DB_PASSWORD}
      - DB_DATABASE=${PROJECTS_DB_NAME}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_SECURE=${SMTP_SECURE}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - EMAIL_FROM=${EMAIL_FROM}
      - FRONTEND_URL=${FRONTEND_URL}

  projects-db:
    build:
      context: ./projects
      dockerfile: Dockerfile.postgres
    ports:
      - "${PROJECTS_DB_PORT}:5432"
    environment:
      - POSTGRES_USER=${PROJECTS_DB_USER}
      - POSTGRES_PASSWORD=${PROJECTS_DB_PASSWORD}
      - POSTGRES_DB=${PROJECTS_DB_NAME}
    volumes:
      - ./projects/postgres-data:/var/lib/postgresql/data
      - ./projects/postgres-init:/docker-entrypoint-initdb.d
    command: >
      postgres
      -c listen_addresses='*'
      -c max_connections=100
      -c timezone='America/Argentina/Buenos_Aires'
      -c log_timezone='America/Argentina/Buenos_Aires'
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${PROJECTS_DB_USER} -d ${PROJECTS_DB_NAME}",
        ]
      interval: 5s
      timeout: 5s
      retries: 5

  communities:
    build: ./communities
    volumes:
      - ./communities/src:/src/app/src
    depends_on:
      communities-db:
        condition: service_healthy
    environment:
      - NATS_SERVERS=nats://nats-server:4222
      - DB_HOST=communities-db
      - DB_PORT=5432
      - DB_USERNAME=${COMMUNITIES_DB_USER}
      - DB_PASSWORD=${COMMUNITIES_DB_PASSWORD}
      - DB_DATABASE=${COMMUNITIES_DB_NAME}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_SECURE=${SMTP_SECURE}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - EMAIL_FROM=${EMAIL_FROM}
      - FRONTEND_URL=${FRONTEND_URL}

  communities-db:
    build:
      context: ./communities
      dockerfile: Dockerfile.postgres
    ports:
      - "${COMMUNITIES_DB_PORT}:5432"
    environment:
      - POSTGRES_USER=${COMMUNITIES_DB_USER}
      - POSTGRES_PASSWORD=${COMMUNITIES_DB_PASSWORD}
      - POSTGRES_DB=${COMMUNITIES_DB_NAME}
    volumes:
      - ./communities/postgres-data:/var/lib/postgresql/data
      - ./communities/postgres-init:/docker-entrypoint-initdb.d
    command: >
      postgres
      -c listen_addresses='*'
      -c max_connections=100
      -c timezone='America/Argentina/Buenos_Aires'
      -c log_timezone='America/Argentina/Buenos_Aires'
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${COMMUNITIES_DB_USER} -d ${COMMUNITIES_DB_NAME}",
        ]
      interval: 5s
      timeout: 5s
      retries: 5

  services:
    build: ./services
    volumes:
      - ./services/src:/src/app/src
    depends_on:
      services-db:
        condition: service_healthy
    environment:
      - NATS_SERVERS=nats://nats-server:4222
      - DB_HOST=services-db
      - DB_PORT=5432
      - DB_USERNAME=${SERVICES_DB_USER}
      - DB_PASSWORD=${SERVICES_DB_PASSWORD}
      - DB_DATABASE=${SERVICES_DB_NAME}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_SECURE=${SMTP_SECURE}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - EMAIL_FROM=${EMAIL_FROM}
      - FRONTEND_URL=${FRONTEND_URL}
      - API_BASE_URL=${API_BASE_URL}
      - NODE_ENV=${NODE_ENV}
      - MERCADOPAGO_ACCESS_TOKEN=${MERCADOPAGO_ACCESS_TOKEN}
      - MERCADOPAGO_PUBLIC_KEY=${MERCADOPAGO_PUBLIC_KEY}
      - MERCADOPAGO_WEBHOOK_SECRET=${MERCADOPAGO_WEBHOOK_SECRET}
      - MERCADOPAGO_SELLER_COLLECTOR_ID=${MERCADOPAGO_SELLER_COLLECTOR_ID}

  services-db:
    build:
      context: ./services
      dockerfile: Dockerfile.postgres
    ports:
      - "${SERVICES_DB_PORT}:5432"
    environment:
      - POSTGRES_USER=${SERVICES_DB_USER}
      - POSTGRES_PASSWORD=${SERVICES_DB_PASSWORD}
      - POSTGRES_DB=${SERVICES_DB_NAME}
    volumes:
      - ./services/postgres-data:/var/lib/postgresql/data
      - ./services/postgres-init:/docker-entrypoint-initdb.d
    command: >
      postgres
      -c listen_addresses='*'
      -c max_connections=100
      -c timezone='America/Argentina/Buenos_Aires'
      -c log_timezone='America/Argentina/Buenos_Aires'
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${SERVICES_DB_USER} -d ${SERVICES_DB_NAME}",
        ]
      interval: 5s
      timeout: 5s
      retries: 5

  # Ngrok para exponer el API Gateway y recibir webhooks de MercadoPago
  # Configurado para fallar silenciosamente si el endpoint ya existe
  ngrok:
    image: ngrok/ngrok:3-alpine
    restart: "no" # No reiniciar si falla por endpoint ocupado
    command:
      - "http"
      - "api-gateway:8080"
      - "--log"
      - "stdout"
      - "--host-header"
      - "rewrite"
      - "--pooling-enabled" # Permite load balancing con t√∫neles existentes
    ports:
      - "4040:4040" # Puerto web UI de ngrok
    depends_on:
      - api-gateway
    environment:
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}
    profiles:
      - ngrok # Solo se ejecuta si se especifica: docker-compose --profile ngrok up
