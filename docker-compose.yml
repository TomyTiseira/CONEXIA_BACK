services:
  nats-server:
    image: nats:2.10.25-alpine3.21
    ports:
      - "8222:8222"
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

  api-gateway:
    build: ./api-gateway
    ports:
      - "${API_GATEWAY_PORT}:${API_GATEWAY_PORT}"
    volumes:
      - ./api-gateway/src:/src/app/src
      - ./api-gateway/uploads:/src/app/uploads
      - ./api-gateway/uploads/cv:/src/app/uploads/cv
    environment:
      - NATS_SERVERS=nats://nats-server:4222
      - PORT=${API_GATEWAY_PORT}
      - JWT_SECRET=${JWT_SECRET}
      - CORS_ORIGINS=${CORS_ORIGINS}
      - NODE_OPTIONS=--max-old-space-size=1024
      - NATS_TIMEOUT=30000
      - NATS_MAX_RECONNECT_ATTEMPTS=10
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  users:
    build: ./users
    volumes:
      - ./users/src:/src/app/src
    depends_on:
      users-db:
        condition: service_healthy
    environment:
      - NATS_SERVERS=nats://nats-server:4222
      - DB_HOST=users-db
      - DB_PORT=${USERS_DB_PORT}
      - DB_USERNAME=${USERS_DB_USER}
      - DB_PASSWORD=${USERS_DB_PASSWORD}
      - DB_DATABASE=${USERS_DB_NAME}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_SECURE=${SMTP_SECURE}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - EMAIL_FROM=${EMAIL_FROM}
      - JWT_SECRET=${JWT_SECRET}
      - NODE_OPTIONS=--max-old-space-size=2048 --expose-gc --max-semi-space-size=128
      - NATS_TIMEOUT=30000
      - NATS_MAX_RECONNECT_ATTEMPTS=10
    deploy:
      resources:
        limits:
          memory: 3G
        reservations:
          memory: 1G

  users-db:
    build:
      context: ./users
      dockerfile: Dockerfile.postgres
    ports:
      - "${USERS_DB_PORT}:${USERS_DB_PORT}"
    environment:
      - POSTGRES_USER=${USERS_DB_USER}
      - POSTGRES_PASSWORD=${USERS_DB_PASSWORD}
      - POSTGRES_DB=${USERS_DB_NAME}
    volumes:
      - ./users/postgres-data:/var/lib/postgresql/data
      - ./users/postgres-init:/docker-entrypoint-initdb.d
    command: >
      postgres
      -c listen_addresses='*'
      -c max_connections=100
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${USERS_DB_USER} -d ${USERS_DB_NAME}"]
      interval: 5s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 1.5G
        reservations:
          memory: 512M

  projects:
    build: ./projects
    volumes:
      - ./projects/src:/src/app/src
    depends_on:
      projects-db:
        condition: service_healthy
    environment:
      - NATS_SERVERS=nats://nats-server:4222
      - DB_HOST=projects-db
      - DB_PORT=5432
      - DB_USERNAME=${PROJECTS_DB_USER}
      - DB_PASSWORD=${PROJECTS_DB_PASSWORD}
      - DB_DATABASE=${PROJECTS_DB_NAME}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_SECURE=${SMTP_SECURE}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - EMAIL_FROM=${EMAIL_FROM}
      - FRONTEND_URL=${FRONTEND_URL}
      - NODE_OPTIONS=--max-old-space-size=1024 --expose-gc --max-semi-space-size=64
      - NATS_TIMEOUT=30000
      - NATS_MAX_RECONNECT_ATTEMPTS=10
    deploy:
      resources:
        limits:
          memory: 1.5G
        reservations:
          memory: 512M

  projects-db:
    build:
      context: ./projects
      dockerfile: Dockerfile.postgres
    ports:
      - "${PROJECTS_DB_PORT}:5432"
    environment:
      - POSTGRES_USER=${PROJECTS_DB_USER}
      - POSTGRES_PASSWORD=${PROJECTS_DB_PASSWORD}
      - POSTGRES_DB=${PROJECTS_DB_NAME}
    volumes:
      - ./projects/postgres-data:/var/lib/postgresql/data
      - ./projects/postgres-init:/docker-entrypoint-initdb.d
    command: >
      postgres
      -c listen_addresses='*'
      -c max_connections=100
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${PROJECTS_DB_USER} -d ${PROJECTS_DB_NAME}",
        ]
      interval: 5s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 1.5G
        reservations:
          memory: 512M

  communities:
    build: ./communities
    volumes:
      - ./communities/src:/src/app/src
    depends_on:
      communities-db:
        condition: service_healthy
    environment:
      - NATS_SERVERS=nats://nats-server:4222
      - DB_HOST=communities-db
      - DB_PORT=5432
      - DB_USERNAME=${COMMUNITIES_DB_USER}
      - DB_PASSWORD=${COMMUNITIES_DB_PASSWORD}
      - DB_DATABASE=${COMMUNITIES_DB_NAME}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_SECURE=${SMTP_SECURE}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - EMAIL_FROM=${EMAIL_FROM}
      - FRONTEND_URL=${FRONTEND_URL}
      # Configuraciones optimizadas para recomendaciones (MEMORY OPTIMIZED)
      - RECOMMENDATIONS_CACHE_TTL=${RECOMMENDATIONS_CACHE_TTL:-1200000}
      - RECOMMENDATIONS_MAX_CACHE_SIZE=${RECOMMENDATIONS_MAX_CACHE_SIZE:-3000}
      - MAX_PARALLEL_PROCESSING=${MAX_PARALLEL_PROCESSING:-2}
      - MUTUAL_FRIENDS_THRESHOLD=${MUTUAL_FRIENDS_THRESHOLD:-1}
      - SKILLS_MATCH_THRESHOLD=${SKILLS_MATCH_THRESHOLD:-2}
      - MAX_FRIENDS_FOR_CALCULATION=${MAX_FRIENDS_FOR_CALCULATION:-15}
      - NODE_OPTIONS=--max-old-space-size=1024 --expose-gc --max-semi-space-size=64
      - NATS_TIMEOUT=30000
      - NATS_MAX_RECONNECT_ATTEMPTS=10
    deploy:
      resources:
        limits:
          memory: 1.5G
        reservations:
          memory: 512M

  communities-db:
    build:
      context: ./communities
      dockerfile: Dockerfile.postgres
    ports:
      - "${COMMUNITIES_DB_PORT}:5432"
    environment:
      - POSTGRES_USER=${COMMUNITIES_DB_USER}
      - POSTGRES_PASSWORD=${COMMUNITIES_DB_PASSWORD}
      - POSTGRES_DB=${COMMUNITIES_DB_NAME}
      # Configuraciones optimizadas para recomendaciones (MEMORY OPTIMIZED)
      - POSTGRES_WORK_MEM=${POSTGRES_WORK_MEM:-64MB}
      - POSTGRES_SHARED_BUFFERS=${POSTGRES_SHARED_BUFFERS:-128MB}
      - POSTGRES_EFFECTIVE_CACHE_SIZE=${POSTGRES_EFFECTIVE_CACHE_SIZE:-512MB}
      - POSTGRES_RANDOM_PAGE_COST=${POSTGRES_RANDOM_PAGE_COST:-1.1}
    volumes:
      - ./communities/postgres-data:/var/lib/postgresql/data
      - ./communities/postgres-init:/docker-entrypoint-initdb.d
    command: >
      postgres
      -c listen_addresses='*'
      -c max_connections=100
      -c work_mem=${POSTGRES_WORK_MEM:-64MB}
      -c shared_buffers=${POSTGRES_SHARED_BUFFERS:-128MB}
      -c effective_cache_size=${POSTGRES_EFFECTIVE_CACHE_SIZE:-512MB}
      -c random_page_cost=${POSTGRES_RANDOM_PAGE_COST:-1.1}
      -c seq_page_cost=1.0
      -c cpu_tuple_cost=0.01
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${COMMUNITIES_DB_USER} -d ${COMMUNITIES_DB_NAME}",
        ]
      interval: 5s
      timeout: 5s
      retries: 5
